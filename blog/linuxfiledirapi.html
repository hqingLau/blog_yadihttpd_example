<!DOCTYPE html>
<html lang="zh">

<head>
    <title>文件和目录API
_hqinglau的博客_Orz linux</title>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="sogou_site_verification" content="wEcD18BWjC">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5">
<meta name="description" content="刘欢庆的博客，分享Linux，操作系统，编程语言的日志。">
<meta name="keywords" content="Linux,C/C++,个人博客,编程,program,计算机,操作系统">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
<link href="/css/my.css" rel="stylesheet" />
<link href="/css/prism.css" rel="stylesheet" />
<style>
  .layui-side {
    position: fixed;
    top: 0;
    background-color: #fff;
    width: 240px;
    margin-left: 10px;
    margin-right: 10px;
    bottom: 0;
  }

  .layui-main {
    margin-top: 40px;
    bottom: 0;
  }

  .header {
    height: 40px;
    width: 100%;
    background-color: #fff;
  }

  .fix-header {
    position: fixed;
    top: 0
  }

  @media screen and (max-device-width:730px) {
    #mySidenav {
      display: none;
    }
  }

  .line {
    width: 100%;
    height: 2px;
    margin: 10px 0;
    overflow: hidden;
    background-color: #eee;
    font-size: 0;
  }
</style>
</head>

<body>
  <script type="text/javascript">
    var ua = navigator.userAgent.toLowerCase();
    var isWeixin = ua.indexOf('micromessenger') != -1;
    if (isWeixin) {
      document.getElementsByTagName('html')[0].innerHTML = "<div style='text-align:right; margin:20px;'>请点击右上角浏览器打开</div><img src='/img/log.jpg' style='display:block;margin:30vh auto;height:20%'></div>";
    }
  </script>
  <script type="text/javascript">
    function openNav() {
      document.getElementById("mySidenav").style.display = "block";

      var windowWidth = document.body.clientWidth;
      if (windowWidth > 700) {
        document.getElementById("mymain").style.marginLeft = "260px";
        document.getElementById("topheader").style.left = "260px";
      }
      else {
        document.getElementById("mymain").style.marginLeft = "0";
      }
      document.getElementById("sidebarbtn").onclick = function () {
        closeNav();
      }

    }

    function closeNav() {
      document.getElementById("mySidenav").style.display = "none";
      document.getElementById("mymain").style.marginLeft = "0";
      document.getElementById("topheader").style.left = "0";
      document.getElementById("sidebarbtn").onclick = function () {
        openNav();
      }

    }
  </script>

  <div>
    <div class="layui-side" id="mySidenav">
      <div class="aside_content" id="aside_content">
        <div class="card-content">
          <div class="card-info-avatar is-center">
            <a href="/">
              <img class="avatar-img" src="https://gitee.com/hqinglau/img/raw/master/logo.jpg" alt="avatar">
            </a>
            <div class="author-info__name">hqinglau的网络日志</div>
            <div class="author-info__description">
              <p>记录Linux, 编程, 操作系统...</p>
            </div>
          </div>
          </br>
        </div>
        <div class="line dk hidden-folded"></div>



        </br>
        <div style="padding-left:50px;">

          <a href="https://orzlinux.cn"
            style="text-decoration:none; color:black;cursor:pointer; font-size:16px; padding-top:5px">
            <span class="fa-stack">
              <i class="fa   fa-lg fa-home fa-stack-1x"></i>
            </span>
            Home
          </a>
          </br>
          <a href="https://github.com/hqinglau"
            style="text-decoration:none; color:black;cursor:pointer; font-size:16px; padding-top:5px">

            <span class="fa-stack">
              <i class="fa  fa-lg fa-github fa-stack-1x"></i>
            </span>
            github
          </a>
          </br>

          <a href="https://orzlinux.cn/blog/yadihttpd.html"
            style="text-decoration:none; color:black;cursor:pointer; font-size:16px; padding-top:5px">

            <span class="fa-stack">
              <i class="fa  fa-lg  fa-server fa-stack-1x"></i>
            </span>
            File Server
          </a>
          </br>
          <a href="/uploadBlog.html"
            style="text-decoration:none; color:black;cursor:pointer; font-size:16px; padding-top:5px">

            <span class="fa-stack">
              <i class="fa  fa-lg  fa-upload fa-stack-1x"></i>
            </span>
            Upload
          </a>
          </br>
        </div>




      </div>
    </div>
    <div class="layui-main" id="mymain">
      <div class="header fix-header" id="topheader" style="display:none;">
        <span id="sidebarbtn" style="margin:10px; color: #ccc;font-size:20px;cursor:pointer" onclick="openNav()">&#9776;
        </span>
        <span style="font-size:20px;cursor:pointer;"><a href="https://orzlinux.cn"
            style="text-decoration:none; color:#999; font-size:18px;cursor:pointer;"> hqinglau的博客</a> </span>
      </div>




      <script type="text/javascript">
        var lastW = 0;
        var resizeTimer = null;
        //定义变量获取屏幕视口宽度
        function mywinresize() {

          var windowWidth = document.body.clientWidth;
          if (Math.abs(lastW - windowWidth) < 50) {
            return windowWidth;
          }
          console.log(windowWidth);
          if (windowWidth > 700) {
            openNav();
          }
          else {
            closeNav();
          }
          return windowWidth;
        }
        lastW = mywinresize();
        document.getElementById("topheader").style.display = "block";
        window.addEventListener('resize', function () {
          if (resizeTimer) clearTimeout(resizeTimer);
          resizeTimer = setTimeout(function () {
            lastW = mywinresize();
          }, 500);
        });
      </script>





      <article id="page">
        <div class="article-container">
          <div><h1>文件和目录API</h1><hr>
<h2 id="文件">文件</h2>
<p>存储虚拟化两个抽象：文件和目录。在 UNIX 系统中，文件系统提供了一种统一的方式来访问磁盘、 U 盘、 CD-ROM、许多其他设备上的文件，事实上还有很多其他的东西，都位于单一目录树下。  </p>
<p><code>O_TRUNC</code>：truncation（截断），截断为零字节大小，删除现有内容。</p>
<blockquote>
<p><code>strace</code>：跟踪程序在运行时所做的每个系统调用。</p>
</blockquote>
<pre><code class="language-shell">$ strace -e trace=open,close,read cat foo 
open(&quot;tls/x86_64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
# ... 一些共享库
open(&quot;foo&quot;, O_RDONLY)                   = 3
read(3, &quot;hi\n&quot;, 65536)                  = 3
hi
read(3, &quot;&quot;, 65536)                      = 0
close(3)                                = 0
# ...
+++ exited with 0 +++
$ 
</code></pre>
<p>常用系统调用函数：</p>
<pre><code class="language-c">int open(const char *pathname, int flags, mode_t mode);
ssize_t read(int fd, void *buf, size_t count);
// write告诉文件系统，你有空了写一下。
// 性能原因，会在内存缓冲一段时间再写入磁盘
ssize_t write(int fd, const void *buf, size_t count);
// 根据偏移量定位
// lseek()调用只是在 OS 内存中更改一个变量，该变量跟踪特定进
// 程的下一个读取或写入开始的偏移量，磁头并不会真的移过去
off_t lseek(int fd, off_t offset, int whence);
// 强制写入磁盘
int fsync(int fd);
</code></pre>
<blockquote>
<p>C库的<code>fflush</code>写入到内核缓冲区，<code>fsync</code>把内核缓冲到磁盘上（阻塞）。</p>
<p>C库 - ffush - 内核缓冲 - fsync - 磁盘。</p>
</blockquote>
<pre><code class="language-shell">$ strace mv foo foo.txt
# ... 一些操作
geteuid()                               = 1000
ioctl(0, TCGETS, {B38400 opost isig icanon echo ...}) = 0
stat(&quot;foo.txt&quot;, 0x7ffff8abd4f0)         = -1 ENOENT (No such file or directory)
lstat(&quot;foo&quot;, {st_mode=S_IFREG|0664, st_size=3, ...}) = 0
lstat(&quot;foo.txt&quot;, 0x7ffff8abd1a0)        = -1 ENOENT (No such file or directory)
renameat2(AT_FDCWD, &quot;foo&quot;, AT_FDCWD, &quot;foo.txt&quot;, 0) = 0
lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)
close(0)                                = 0
# ...
+++ exited with 0 +++
$ 
</code></pre>
<blockquote>
<p><code>lstat</code>如果是符号链接，会返回符号链接信息。</p>
</blockquote>
<p><code>rename</code>：文件重命名</p>
<pre><code class="language-c">int rename(const char *oldpath, const char *newpath);
</code></pre>
<p>通常是一个原子调用，可用于原子文件更新，先写入临时文件，再<code>rename</code>。</p>
<pre><code class="language-c">int fd = open(&quot;foo.txt.tmp&quot;,O_WRONLY|O_CREAT|O_TRUNC);
char buffer[64];
sprintf(buffer,&quot;%s&quot;,&quot;haha&quot;);
write(fd,buffer,strlen(buffer));
fsync(fd);
close(fd);
rename(&quot;foo.txt.tmp&quot;,&quot;foo.txt&quot;);
</code></pre>
<p>结果：</p>
<pre><code class="language-shell">$ gcc filedir.c 
$ ./a.out 
$ ls foo.txt*
foo.txt
$ cat foo.txt 
haha
</code></pre>
<p>获取文件信息<code>stat</code>，之前记录过，<a href="https://orzlinux.cn/blog/file_stat.html">链接</a>。</p>
<pre><code class="language-shell">$ stat foo.txt 
  File: ‘foo.txt’
  Size: 4               Blocks: 8          IO Block: 4096   regular file
Device: fc01h/64513d    Inode: 917765      Links: 1
Access: (1670/-rw-rwx--T)  Uid: ( 1000/hqinglau)   Gid: ( 1000/hqinglau)
Access: 2021-08-29 00:35:12.792958656 +0800
Modify: 2021-08-29 00:35:03.558728757 +0800
Change: 2021-08-29 00:35:03.567728981 +0800
 Birth: -
$
</code></pre>
<h2 id="目录">目录</h2>
<p>不能直接写入目录，只能间接更新目录。</p>
<p>创建：<code>mkdir()</code>，创建空目录，包含两个条目，当前引用<code>.</code>和父目录<code>..</code>（点-点）。</p>
<p>使用：<code>opendir()</code>，<code>closedir()</code>，<code>readdir()</code>读取条目结构体<code>dirent</code>（dir entry）。</p>
<p>错误尝试：</p>
<pre><code class="language-c">int fd = open(&quot;foodir&quot;,O_RDONLY);
char buf[64];
read(fd,buf,63);
printf(&quot;%s\n&quot;,buf);
// 结果为空
// write也为空，但是测试显示没报错
</code></pre>
<p>正确用法：</p>
<pre><code class="language-c">DIR *dp = opendir(&quot;foodir&quot;);
struct dirent *d;
while ((d=readdir(dp))!=NULL) {
    printf(&quot;%d %s\n&quot;,(int)d-&gt;d_ino,d-&gt;d_name);
}
closedir(dp);
// 输出
// 917767 footxt
// 917766 .
// 917759 ..
</code></pre>
<p>目录只是将信息映射到<code>inode</code>号，具体的用<code>stat()</code>获取详细信息。</p>
<p><code>rmdir()</code>要求目录是空的。</p>
<p>硬链接：文件系统取消链接文件时，或检查inode号的引用计数，<code>unlink()</code>删除文件会删除文件名和inode的链接，减少引用计数，删文件要用<code>unlink()</code>。</p>
<p>软链接：大小为文件名大小</p>
<pre><code class="language-shell">$ ln -s foodir/footxt foolink
$ ls -l foolink 
... 13 Aug 29 01:02 foolink -&gt; foodir/footxt
</code></pre>
<p>所以软链接可能指向空。</p>
<p>最后一个小练习：遍历目录下所有文件。</p>
<p>一个关键点就是路径问题。</p>
<pre><code class="language-c">// 递归
void dilistdir(char *root,char *prefix)
{
    char pre[128];
    char ro[128];
    sprintf(pre,&quot;%s%s&quot;,&quot;    &quot;,prefix);
    DIR *dp = opendir(root);
    struct dirent *d;
    struct stat buf;
    while ((d=readdir(dp))!=NULL) {
        if(strcmp(d-&gt;d_name,&quot;.&quot;)==0||strcmp(d-&gt;d_name,&quot;..&quot;)==0)
            continue;
        printf(&quot;%s%s\n&quot;,prefix,d-&gt;d_name);
        sprintf(ro,&quot;%s/%s&quot;,root,d-&gt;d_name);
        stat(ro,&amp;buf);
        if(S_ISDIR(buf.st_mode)==1)
        {
            dilistdir(ro,pre);
            continue;
        }
    }

    closedir(dp);
}


int main()
{
    printf(&quot;foodir/\n&quot;);
    dilistdir(&quot;foodir&quot;,&quot;|-- &quot;);
    return 0;
}
</code></pre>
<p>输出示例：</p>
<pre><code class="language-shell">$ ./a.out 
foodir/
|-- footxt
|-- foodir3
    |-- foo.txt3
|-- foodir2
    |-- foo.txt2
    |-- foo.txt22
|-- bar
</code></pre>
</div>


</div>
<br>
<div id="banquan-yadi" style="display:none">
	<blockquote style="line-height:1.2;padding-bottom:10px;">
		<p>本文地址:
			<a href="https://orzlinux.cn" id="blogaddr-a" style="text-decoration:none; color:black;cursor:pointer;">
				hqinglau的博客</a>
		</p>
		<p>作者:
			<a href="https://orzlinux.cn" style="text-decoration:none; color:black;cursor:pointer;">
				hqinglau
			</a>
		</p>
		<p>博客地址:
			<a href="https://orzlinux.cn" style="text-decoration:none; color:black;cursor:pointer;">
				https://orzlinux.cn
			</a>
		</p>

		<p>版权说明: 如无注明，本文皆由
			<a href="https://orzlinux.cn" style="text-decoration:none; color:black;cursor:pointer;">
				hqinglau
			</a>原创，转载请保留文章出处
		</p>
	</blockquote>
</div>
</article>
</div>
<div id="footer-wrap">
	<div class="copyright">Powered by <a style="color:#4c4948;text-decoration:none;"
			href="https://github.com/hqinglau/yadihttpd">yadihttpd</a></div>
	<div class="copyright">Copyright © 2021 hqinglau</div>
	<div style="width:300px;margin:0 auto; padding:5px 0;">
		<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41022102001049"
			style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img
				src="https://orzlinux.cn/img/beian.png" style="float:left;">
			<p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">豫公网安备
				41022102001049号</p>
		</a>
	</div>
</div>
</div>
<script src="/js/prism.js"></script>

<!-- 看板娘 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <script type="text/javascript">
    document.getElementById("banquan-yadi").style.display ="";
  document.getElementById("blogaddr-a").href ="https://orzlinux.cn/blog/"+"linuxfiledirapi.html";
  document.getElementById("blogaddr-a").innerHTML="文件和目录API";
</script></body></html> 
